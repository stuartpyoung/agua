#!/usr/bin/perl -w

#### DEBUG

#### TIME
my $time = time();

=head2

    APPLICATION     ELAND

    VERSION         0.01

    PURPOSE

        WRAPPER SCRIPT FOR RUNNING ELAND ASSEMBLY

    INPUT

        1. ASSEMBLY DIRECTORY

        2. FASTA OR FASTQ INPUT FILES

    OUTPUT

        1. ELAND OUTPUT FILES IN ASSEMBLY DIRECTORIES

		2. CREATES ONE ASSEMBLY SUB-DIRECTORY PER CHROMOSOME IN

			THE USER-SPECIFIED OUTPUT DIRECTORY

	NOTES

		Running ELAND as a standalone program
		http://rulai.cshl.edu/xuan/Doc/Solexa/docs/Whole%20genome%20alignments%20using%20ELAND.html

		The eland_extended and eland_pair modes introduced in Pipeline version 0.3 share a common 'export' file format. The intention of this file is to combine all the important information for a lane into one file (or two files in the case of a paired read run). These scripts:

		Bring in the base quality value information
		Use the base quality values to pick the best alignment (taking into account read-pairing if relevant)
		Give a quality score to the alignment
		You do not get these files just by running the ELAND executable, the export files are generated by running several scripts to postprocess the raw ELAND output.
		There seems to be an increasingly common requirement to run this set of scripts in a 'standalone' fashion. This can be done via the script Pipeline/Eland/ELAND_standalone.pl. Minimal usage:

		./Pipeline/Eland/ELAND_standalone.pl -if read1.fastq -if read2.fastq -it fastq
		-eg /lustre/data01/Mondas_software/Genomes/E_coli_ELAND		


		ELAND_standalone.pl USAGE:

			Usage: ./ELAND_standalone.pl options

			--input-file|if 			must specify at least one file, specify two for paired analysis
			--input-type|it 			type of input file: fastq, fasta, export or qseq
			--read-length|rl			will work it out from input file(s) if not specified
			--seed-length|sl			length of read used for ELAND alignment 
										- default is to min of read-length and 32
			--eland-genome|eg			full path of a squashed genome directory
			--output-prefix|op			will produce a set of output files whose names prefixed by this
										- defaults to 'reanalysis'  
			--pipeline-dir|pd			path of pipeline installation to call 
										- by default, looks in same dir as executable is found)
			--base-quality|bq			in fasta mode assume all bases have this quality
										- default is set to 30
			--pair-params|pp			paired read analysis parameters to pass to pickBestPair
										- multiple arguments must go in quotes
										- defaults to '--circular' - treats all chromosomes as circular


			NB: For a paired read analysis, both reads must share same input-type, read-length and seed-length

			NB: If you want to e.g. produce a set of export files for submission then it is probably best to re-run GERALD part of the pipeline to get a 'proper' analysis.

			NB: ELAND_standalone.pl uses Solexa's fastq encoding scheme (ASCII character = quality value + 64) rather than the more standard ASCII character = quality value + 32


			See: Data analysis - documentation : Whole genome alignments using ELAND
			Copyright (c) Illumina Inc. 2007. All rights reserved.
			Author: Anthony J. Cox
			http://bisr.osumc.edu/docs/Whole%20genome%20alignments%20using%20ELAND.html


			IMPORTANT CHANGES IN 1.4:

			- The format of the Firecrest output has changed. The intensity and noise
			  files are now generated cycle by cycle (same format as IPAR)
			- Bustard supports the binary data format generated by RTA (with the --CIF
			- The pipeline uses the data from the file RunInfo.xml (normally generated
			  by SCS) to identify the boundaries of the reads (including index reads).
			- Improved the estimation of the alignment scores of longer reads.
			- phageAlign produces export files


			NOTE: Running ELAND_standalone.pl is better than running the ELAND executable, which just gives the raw match output for all sequences. It does not take account of quality-filtering nor of base quality values. 

			IMPORTANT CHANGES IN 1.3:

			- A new build system is used. The installation still involves installing the
			  prerequisites and then typing "make" and "make install" in the top-level
			  pipeline folder. The executables can now be found in the bin/ directory
			  (e.g. bin/goat_pipeline.py).
			- The Bustard output formats have changed; a new file format called "qseq.txt"
			  is used to store read IDs, sequence and quality information as well as
			  filter information. The old file formats can be produced optionally with the
			  "--with-seq", "--with-prb", "--with-siq2", "--with-qval" options.
			- For base-call auto-calibration, the option "--with-qval" needs to be
			  specified at the goat_pipeline.py or bustard.py command line.
			- The Gerald analysis modes "expression" and "eland" are deprecated. They are
			  replaced by "eland_tag" and "eland_extended" respectively.
			- The "CONTAM_FILE" feature in PhageAlign mode is deprecated.

    USAGE

    ./ELAND.pl <--inputfile String> <--outputdir String> <--referencedir String> <--lines Integer> [--convert] [--clean] [--help]

		--inputfile				:   /full/path/to/readfile.fastq
									if paired-end: /../read_1.fastq,/../read_2.fastq
		--rundir				:	/full/path/to/pipeline/rundir
		--inputtype				:   type of input file: fastq, fasta, export or qseq
		--outputdir				:   /full/path/to/output_directory
		--referencedir			:   /full/path/to/squashed_genome_files
		--seedlength			:   Length of read used for ELAND alignment (Default: min. of seedlength and 32)
		--reads					:   Number of reads per sub-file
		--quality				:   Set quality value of all bases in fasta mode (Default: 30)
		--pairparams			:   paired read analysis parameters to pass to pickBestPair
										- multiple arguments must go in quotes
										- defaults to '--circular' - treats all chromosomes as circular
		--outputprefix			:	Prefix output files with this (Default: 'reanalysis')
		--clean					:   Clean run (remove old splitfile)
		--queue					:   Cluster queue options
		--jobs					:   Max. number of concurrent cluster jobs
		--help                 	:   print help info

    EXAMPLES

cd /p/NGS/syoung/base/pipeline/SRA/eland/1

/nethome/syoung/base/bin/nextgen/ELAND.pl \
--inputfile /p/NGS/syoung/base/pipeline/SRA/NA18507/samples/reads_ELAND_1.1.fastq,/p/NGS/syoung/base/pipeline/SRA/NA18507/samples/reads_ELAND_2.1.fastq \
--inputtype fastq \
--referencedir /q/nextGen/GA/refSeqs/chromosomes/hs_chr_sq \
--outputdir /p/NGS/syoung/base/pipeline/SRA/eland/1 \
--splitfile /p/NGS/syoung/base/pipeline/SRA/eland/1/reads.1.fastq.split \
--paired \
--queue "-q psmall" \
--jobs 40

	\
	&> /p/NGS/syoung/base/pipeline/SRA/eland/1/outerr.txt


WHICH CALLS ELAND_standalone.pl

/nethome/syoung/base/apps/GAPipeline-1.4.0/bin/ELAND_standalone.pl \
--input-type fastq \
--eland-genome /q/nextGen/GA/refSeqs/chromosomes/hs_chr_sq \
--input-file /p/NGS/syoung/base/pipeline/SRA/eland/1/1/reads_ELAND_1.1.fastq \
--input-file /p/NGS/syoung/base/pipeline/SRA/eland/1/1/reads_ELAND_2.1.fastq \


=cut

use strict;

#### EXTERNAL MODULES
use Term::ANSIColor qw(:constants);
use Data::Dumper;
use Getopt::Long;
use FindBin qw($Bin);

#### USE LIBRARY
use lib "$Bin/../../../lib";	

#### INTERNAL MODULES
use Sampler;
use Timer;
use Util;
use Conf::Agua;

##### STORE ARGUMENTS TO PRINT TO FILE LATER
my @arguments = @ARGV;

#### FLUSH BUFFER
$| =1;

#### SET ELAND LOCATION
my $conf = Conf::Agua->new(inputfile=>"$Bin/../../../conf/default.conf");
my $eland = $conf->getKeyValue("applications", 'ELAND');
my $msub = $conf->getKeyValue("agua", 'MSUB');
print "eland: $eland\n";
print "msub: $msub\n";

#### DEFAULT MAX FILE LINES (MULTIPLE OF 4 BECAUSE EACH FASTQ RECORD IS 4 LINES)
#### DEFAULT IS 500,000 RECORDS (2,000,000 LINES)
my $max_lines = 2000000;

#### GET OPTIONS
my $inputfile;
my $rundir;
my $inputtype;
my $outputdir;
my $referencedir;
my $splitfile;
my $seedlength;
my $paired;
my $reads;
my $clean;
my $quality;
my $pairparams;
my $outputprefix;

#### CLUSTER OPTIONS
my $jobs = 30;
my $sleep = 5;
my $queue;
my $dot = 1;

my $help;
if ( not GetOptions (
    'inputfile=s' => \$inputfile,
    'inputtype=s' => \$inputtype,
    'outputdir=s' => \$outputdir,
    'referencedir=s' => \$referencedir,
    'splitfile=s' => \$splitfile,
    'seedlength=i' => \$seedlength,
    'paired' => \$paired,
    'reads=i' => \$reads,
    'clean' => \$clean,
    'quality' => \$quality,
    'pairparams' => \$pairparams,
    'outputprefix' => \$outputprefix,

    'queue=s' => \$queue,
    'jobs=s' => \$jobs,
    'help' => \$help
) )
{ print "Use option --help for usage instructions.\n";  exit;    };

#### SET NUMBER OF LINES IF reads OPTION WAS USED
$max_lines = $reads * 4 if defined $reads;

#### PRINT HELP
if ( defined $help )	{	usage();	}

#### CHECK INPUTS
die "Input file not defined (Use --help for usage)\n" if not defined $inputfile;
die "Input type not defined (Use --help for usage)\n" if not defined $inputtype;
die "Output directory not defined (Use --help for usage)\n" if not defined $outputdir;
die "Reference directory not defined (Use --help for usage)\n" if not defined $referencedir;
die "Input type not supported (must be fastq, fasta, export or qseq): $inputtype\n" if $inputtype !~ /^(fastq|fasta|export|qseq)$/i;

print "inputfile: $inputfile\n";
print "outputdir: $outputdir\n";
print "referencedir: $referencedir\n";

#### CHECK INPUTS
if ( not defined $inputfile)   {   print "Input file not defined (option --inputfile)\n";    usage();    }
if ( not defined $outputdir)   {   print "Output directory not defined (option --outputdir)\n";    usage();    }
if ( not defined $referencedir )   {   print "Reference directory not defined (option --referencedir)\n";    usage();    }

#### MAKE OUTPUT DIR
mkdir($outputdir) if not -d $outputdir;

#### IF DEFINED RUNDIR, COPY FILES TO OUTPUT DIR
if ( defined $rundir )
{



}

#### CHECK INPUT FILES
my $inputfiles;
@$inputfiles = split ",", $inputfile;
die "Max two input files (paired end) allowed\n" if scalar(@$inputfiles) > 2;

#### SPLIT INPUT FILE IF > MAX_LINES
if ( not defined $splitfile or not $splitfile )
{
	$splitfile = "$outputdir/splitfiles";	
}
print "splitfile: $splitfile\n";
my $splitfiles;
if ( not defined $clean and ( -f $splitfile and not -z $splitfile ) )
{
	print "Getting split files from splitfile: $splitfile ...\n";
    $splitfiles = Sampler::get_splitfiles($splitfile);
}
else
{
	print "Generating split files...\n";
	$splitfiles = Sampler::set_splitfiles(
		{
			'inputfiles' 	=> 	$inputfile,
			'lines'			=> 	$max_lines,
			'splitfile'		=>	$splitfile,
			'outputdir'		=>	$outputdir,
			'suffix'		=> "fastq"
		}
	);	
	print "Names file printed: $splitfile\n";
}

#### SET READ FILES
my $readfiles;
if ( defined $paired )
{
	my $pairedfiles;
	foreach my $splitfile ( @$splitfiles )
	{
		push @$pairedfiles, "$$splitfile[0] $$splitfile[1]";
	}
	$readfiles = $pairedfiles;
}
else
{
	foreach my $splitfile ( @$splitfiles )
	{
		push @$readfiles, "$$splitfile[0]";
	}
}
#exit;

#### DO THE ELAND match ALIGNMENT TO PRODUCE THE out.map FILES
my $align_commands = [];
foreach my $splitfile ( @$splitfiles )
{
	my $inputfile = $$splitfile[0];
	my $matefile = $$splitfile[1];
	print "inputfile: $inputfile\n";
	print "matefile: $matefile\n";

	my ($outputdir) = $inputfile =~ /^(.+?)\/[^\/]+(,|$)/;
	print "OUTPUTDIR: $outputdir\n";

	my $command = qq{$eland \\
--input-type $inputtype \\
--eland-genome $referencedir \\
};
	$command .= qq{--input-file $inputfile \\\n};
	$command .= qq{--input-file $matefile \\\n} if defined $matefile;	
	$command .= qq{--seedlength $seedlength \\\n} if defined $seedlength;
	$command .= qq{--base-quality $quality \\\n} if defined $quality;
	$command .= qq{--pair-params $pairparams \\\n} if defined $pairparams;

$command .= "\n";

	print "$command\n";
	push @$align_commands, $command;

	#Usage: ./ELAND_standalone.pl options
	#
	#--input-file|if 			must specify at least one file, specify two for paired analysis
	#--input-type|it 			type of input file: fastq, fasta, export or qseq
	#--read-length|rl			will work it out from input file(s) if not specified
	#--seed-length|sl			length of read used for ELAND alignment 
	#							- default is to min of read-length and 32
	#--eland-genome|eg			full path of a squashed genome directory
	#--output-prefix|op			will produce a set of output files whose names prefixed by this
	#							- defaults to 'reanalysis'  
	#--pipeline-dir|pd			path of pipeline installation to call 
	#							- by default, looks in same dir as executable is found)
	#--base-quality|bq			in fasta mode assume all bases have this quality
	#							- default is set to 30
	#--pair-params|pp			paired read analysis parameters to pass to pickBestPair
	#							- multiple arguments must go in quotes
	#							- defaults to '--circular' - treats all chromosomes as circular

}



exit;



######################
#### RUN COMMANDS
######################

#### RUN eland match ON EVERY FILE
my $counter = 0;
my $pids;
my $scriptfiles;
foreach my $commands ( @$align_commands )
{	
    $counter++;
    print "$counter\n" if $counter % $dot == 0;

	#### CREATE DIRECTORIES
	if ( not -d "$outputdir/$counter" )
	{
		mkdir ("$outputdir/$counter");
	}

	#### MOVE TO OUTPUT SUBDIR
	chdir("$outputdir/$counter") or die "Can't move to output subdir: $outputdir/$counter\n";

	#### PRINT SHELL SCRIPT	
	my $scriptfile = "$outputdir/$counter/eland.sh";
	my $usagefile = "$outputdir/$counter/usage.txt";
	open(SHFILE, ">$scriptfile") or die "Can't open script file: $scriptfile\n";
	print SHFILE qq{#!/bin/sh\n\n#PBS -j oe\n};
	foreach my $command ( @$commands )
	{
		print SHFILE "$command\n";
	}
	print SHFILE qq{`/usr/local/bin/qstat -f \$PBS_ID > $usagefile`;
echo "Printed usage file: $usagefile"};
	close(SHFILE);
	chmod(0777, $scriptfile) or die "Can't chmod 0777 script file: $scriptfile\n";

	print "scriptfile printed: $scriptfile\n";
	print `cat $scriptfile`;
	#exit;

	### RUN SHELL SCRIPT ON CLUSTER
	my $msub_command = "$msub $queue $scriptfile";
	print "\n*** $msub_command ***\n";

	#### RUN msub AND STORE PID
	my $pid = `$msub_command`;
	($pid) = $pid =~ /^(\d+)/;
	print "Running job, pid: $pid\n";

	push @$pids, $pid;
	print "Currently ", scalar(@$pids), "in list: @$pids\n";
	print `date`;
	while ( scalar(@$pids) >= $jobs )
	{
		sleep($sleep);
		$pids = Sampler::monitor_jobs($pids, $msub);   
	}

	#### CLEAN UP
	#`rm -fr $scriptfile`;
	push @$scriptfiles, $scriptfile;

    print "Ran inputfile: $inputfile\n";
}

#### WAIT TIL ALL JOBS ARE FINISHED
print "Waiting until the last jobs are finished (", scalar(@$pids), " left)...\n";
while ( defined $pids and scalar(@$pids) > 0 )
{
	sleep($sleep);
	$pids = Sampler::monitor_jobs($pids, $msub);   
}
print "done.\n";
print "Finished running eland match on every subfile.\n";


#### PRINT RUN TIME
my $runtime = Timer::runtime( $time, time() );
print "\nRun time: $runtime\n";
print "Completed $0\n";
print Timer::datetime(), "\n";
print "****************************************\n\n\n";
exit;

#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#									SUBROUTINES
#:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::



=head2

	SUBROUTINE		align

	PURPOSE

		ALIGN SEQUENCE AGAINST REFERENCE

=cut

sub align
{
	my $args		=	shift;

	#### GET VARIABLES
	my $inputfiles		=	$args->{inputfiles};
	my $referencedir	=	$args->{referencedir};
	my $referencebinary	=	$args->{referencebinary};
	my $outputdir		=	$args->{outputdir};
	my $convert			=	$args->{convert};



	####################
	#### DO THE ASSEMBLY
	####################



			#Usage: ./ELAND_standalone.pl options
			#
			#--input-file|if 			must specify at least one file, specify two for paired analysis
			#--input-type|it 			type of input file: fastq, fasta, export or qseq
			#--read-length|rl			will work it out from input file(s) if not specified
			#--seed-length|sl			length of read used for ELAND alignment 
			#							- default is to min of read-length and 32
			#--eland-genome|eg			full path of a squashed genome directory
			#--output-prefix|op			will produce a set of output files whose names prefixed by this
			#							- defaults to 'reanalysis'  
			#--pipeline-dir|pd			path of pipeline installation to call 
			#							- by default, looks in same dir as executable is found)
			#--base-quality|bq			in fasta mode assume all bases have this quality
			#							- default is set to 30
			#--pair-params|pp			paired read analysis parameters to pass to pickBestPair
			#							- multiple arguments must go in quotes
			#							- defaults to '--circular' - treats all chromosomes as circular

	# 4. ALIGN THE READS AGAINST THE REFERENCE USING match 
	my $outerrfile = "$outputdir/outerr.txt";
	#push @$commands, "time $eland match $outputdir/out.map $referencebinary $inputbinaries  &> $outerrfile";
	#
	#return $commands;
}

sub usage
{
	print GREEN;
	print `perldoc $0`;
	print RESET;
	exit;
}


